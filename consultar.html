<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INCTECSA - Consultar Boletas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen p-4"> 
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-blue-600 text-white p-4 rounded-t-lg">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">INCTECSA - Boletas Guardadas</h1>
                <button onclick="window.location.href='boleta.html'" class="bg-white text-blue-600 px-4 py-2 rounded hover:bg-gray-100 transition">
                    Volver al Formulario
                </button>
                <button onclick="reiniciarContador()" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded transition">
                    <i class="fas fa-sync-alt mr-2"></i>Reiniciar Contador
                </button>
            </div>
        </div>
        
        <!-- Boletas Table -->
        <div class="bg-white shadow-lg rounded-b-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operación</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Servicio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="boletasTable" class="bg-white divide-y divide-gray-200">
                        <!-- Las boletas se cargarán aquí con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-gray-200 p-3 text-center text-sm text-gray-600 mt-4 rounded-lg">
            <p>Copyright 2024 | INCTECSA | Reservados todos los derechos</p>
        </div>
    </div>

    <script>
        // Función para dividir nombres largos en dos líneas
        function dividirNombre(nombreCompleto) {
            const partes = nombreCompleto.split(' ');
            if (partes.length <= 2) return nombreCompleto;
            
            const mitad = Math.ceil(partes.length / 2);
            const linea1 = partes.slice(0, mitad).join(' ');
            const linea2 = partes.slice(mitad).join(' ');
            
            return `${linea1}<br>${linea2}`;
        }

        // Cargar y mostrar boletas al abrir la página
        document.addEventListener('DOMContentLoaded', function() {
            cargarBoletas();
        });

        // Cargar boletas desde localStorage
        function cargarBoletas() {
            const boletas = JSON.parse(localStorage.getItem('boletas')) || [];
            const tableBody = document.getElementById('boletasTable');
            
            if (boletas.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            No hay boletas guardadas
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = '';
            
            boletas.forEach((boleta, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${boleta.operacion}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${boleta.fechaHora}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${boleta.servicio}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${dividirNombre(boleta.cliente)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">S/ ${boleta.monto.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">S/ ${boleta.total.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="verDetalle(${index})" class="text-blue-600 hover:text-blue-900 mr-2">Ver</button>
                        <button onclick="imprimirBoleta(${index})" class="text-yellow-600 hover:text-yellow-800 mr-2">
                            <i class="fas fa-print"></i>
                        </button>
                        <button onclick="eliminarBoleta(${index})" class="text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Ver detalle de boleta
        function verDetalle(index) {
            const boletas = JSON.parse(localStorage.getItem('boletas'));
            const boleta = boletas[index];
            
            let detalle = `
                Operación: ${boleta.operacion}\n
                Negocio: ${boleta.negocio}\n
                Dirección: ${boleta.direccion}\n
                Fecha/Hora: ${boleta.fechaHora}\n
                Servicio: ${boleta.servicio}\n
                Empresa: ${boleta.empresa}\n
                Cliente: ${boleta.cliente}\n
                Código/Número: ${boleta.codigo}\n
                Monto Pagado: S/ ${boleta.monto.toFixed(2)}\n
                Comisión: S/ ${boleta.comision.toFixed(2)}\n
                Total: S/ ${boleta.total.toFixed(2)}
            `;
            
            alert(detalle);
        }

                function imprimirBoleta(index) {
    const boletas = JSON.parse(localStorage.getItem('boletas'));
    const boleta = boletas[index];

    // Función para dividir texto en líneas
    const dividirTexto = (texto, maxCaracteres = 20) => {
        texto = texto.toUpperCase();
        if(texto.length <= maxCaracteres) return [texto];
        
        const palabras = texto.split(' ');
        const lineas = [];
        let lineaActual = '';
        
        palabras.forEach(palabra => {
            if((lineaActual + ' ' + palabra).length <= maxCaracteres) {
                lineaActual += (lineaActual ? ' ' : '') + palabra;
            } else {
                lineas.push(lineaActual);
                lineaActual = palabra;
            }
        });
        
        if(lineaActual) lineas.push(lineaActual);
        return lineas;
    };

    // Preparamos los datos
    const fechaHora = boleta.fechaHora.length > 16 ? boleta.fechaHora.substring(0, 16) : boleta.fechaHora;
    const lineasNombre = dividirTexto(boleta.cliente);
    const lineasEmpresa = dividirTexto(boleta.empresa);
    const lineasServicio = dividirTexto(boleta.servicio);

    // Contenido con alineación perfecta
    const contenido = `
        <div style="width:72mm; margin:0 auto; font-family:'Courier New',monospace; font-size:10px; line-height:1.2; text-align:center">
            <!-- Encabezado -->
            <div style="margin-bottom:3px">
                <div style="font-weight:bold; font-size:12px">INCTECSA</div>
                <div>${fechaHora}</div>
                <div>Av. Independencia 247</div>
            </div>
            
            <!-- Separador -->
            <div style="border-top:1px dashed #000; margin:5px 0"></div>
            
            <!-- Bloque de datos alineados -->
            <div style="display:inline-block; text-align:left; margin-bottom:3px">
                <!-- Campos superiores -->
                <div><span style="display:inline-block; width:65px; text-align:left">operacion:</span> ${boleta.operacion}</div>
                <div><span style="display:inline-block; width:65px; text-align:left">negocio:</span> ${boleta.negocio.toUpperCase()}</div>
                <div><span style="display:inline-block; width:65px; text-align:left">servicio:</span> ${lineasServicio[0]}</div>
                ${lineasServicio.length > 1 ? `<div style="margin-left:65px">${lineasServicio[1]}</div>` : ''}
                <div><span style="display:inline-block; width:65px; text-align:left">empresa:</span> ${lineasEmpresa[0]}</div>
                ${lineasEmpresa.length > 1 ? `<div style="margin-left:65px">${lineasEmpresa[1]}</div>` : ''}
                <div><span style="display:inline-block; width:65px; text-align:left">cliente:</span> ${lineasNombre[0]}</div>
                ${lineasNombre.length > 1 ? `<div style="margin-left:65px">${lineasNombre[1]}</div>` : ''}
                <div><span style="display:inline-block; width:65px; text-align:left">codigo:</span> ${boleta.codigo || 'N/A'}</div>
                
                <!-- Separador interno -->
                <div style="border-top:1px dashed #000; margin:5px 0"></div>
                
                <!-- Montos con la misma alineación -->
                <div><span style="display:inline-block; width:65px; text-align:left">monto:</span> S/${boleta.monto.toFixed(2)}</div>
                <div><span style="display:inline-block; width:65px; text-align:left">comision:</span> S/${boleta.comision.toFixed(2)}</div>
                <div><span style="display:inline-block; width:65px; text-align:left">total:</span> S/${boleta.total.toFixed(2)}</div>
            </div>
            
            <!-- Separador final -->
            <div style="border-top:1px dashed #000; margin:5px 0"></div>
            
            <!-- Pie de página -->
            <div style="font-size:9px; margin-top:3px">
                <div>Agua, luz, gas, cable, telefonía</div>
                <div>Recargas virtuales, cosméticos y más</div>
                <div style="margin-top:2px">Gracias por su visita</div>
                <div style="font-weight:bold">CURSOS DE INGENIERÍA & GESTIÓN</div>
            </div>
        </div>
    `;
    
    // Ventana de impresión
    const ventana = window.open('', '_blank');
    ventana.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Boleta ${boleta.operacion}</title>
            <style>
                @page {
                    size: 72mm auto;
                    margin: 0;
                    padding: 0;
                }
                body {
                    margin: 0;
                    padding: 2mm;
                    font-family: 'Courier New', monospace;
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
            </style>
        </head>
        <body onload="window.print(); setTimeout(() => { window.close(); }, 200);">
            ${contenido}
        </body>
        </html>
    `);
    ventana.document.close();
}
        // Eliminar boleta
        function eliminarBoleta(index) {
            if (confirm('¿Está seguro que desea eliminar esta boleta?')) {
                const boletas = JSON.parse(localStorage.getItem('boletas'));
                boletas.splice(index, 1);
                localStorage.setItem('boletas', JSON.stringify(boletas));
                cargarBoletas();
            }
        }

        function reiniciarContador() {
            if (confirm("¿Estás seguro de reiniciar el contador a 00001? Esto no afectará las boletas guardadas.")) {
                localStorage.setItem('ultimaOperacion', '00000');
                alert("Contador reiniciado. La próxima operación será 00001.");
                window.location.href = 'boleta.html';
            }
        }
    </script>
</body>
</html>
